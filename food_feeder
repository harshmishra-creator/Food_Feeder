#include <Wire.h>
#include <RTClib.h>
#include <Servo.h>

RTC_DS3231 rtc;
Servo feederServo;

int buttonPin = 2;
int servoPin = 9;
int ledPin = 13;

int feedHour = 8;   // Feeding time: 08:00
int feedMinute = 0;
bool hasFed = false;  // To make sure it feeds only once per time slot

void setup() {
  Serial.begin(9600);
  Wire.begin();
  rtc.begin();
  feederServo.attach(servoPin);
  pinMode(buttonPin, INPUT_PULLUP);
  pinMode(ledPin, OUTPUT);

  if (rtc.lostPower()) {
    Serial.println("RTC lost power, setting the time!");
    rtc.adjust(DateTime(F(__DATE__), F(__TIME__))); // Set RTC to compile time
  }

  Serial.println("Auto Food Feeder System Started");
}

void loop() {
  DateTime now = rtc.now();
  
  // Display current time
  Serial.print(now.hour());
  Serial.print(":");
  Serial.println(now.minute());

  // Automatic feeding at set time
  if (now.hour() == feedHour && now.minute() == feedMinute && !hasFed) {
    feedPet();
    hasFed = true;  // Avoid repeating feed within same minute
  }

  // Reset flag after minute passes
  if (now.minute() != feedMinute) {
    hasFed = false;
  }

  // Manual feed button
  if (digitalRead(buttonPin) == LOW) {
    Serial.println("Manual Feed Activated");
    feedPet();
    delay(1000); // Debounce delay
  }

  delay(1000);
}

// Feeding function
void feedPet() {
  Serial.println("Feeding...");
  digitalWrite(ledPin, HIGH);
  feederServo.write(90);   // Open gate
  delay(2000);             // Wait for food to drop
  feederServo.write(0);    // Close gate
  digitalWrite(ledPin, LOW);
  Serial.println("Feeding Done");
}
